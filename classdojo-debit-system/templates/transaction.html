{% extends "base.html" %}

{% block title %}New Transaction - ClassDojo Debit System{% endblock %}

{% block content %}
<h1>üí≥ Process Transaction</h1>

<div class="card">
    <h2>Transaction Details</h2>
    
    <form method="POST" action="{{ url_for('transaction') }}">
        <div class="form-group">
            <label for="card_id">Card ID *</label>
            <input type="text" id="card_id" name="card_id" required 
                   placeholder="Scan or enter card ID" autofocus>
            <small style="color: #6c757d;">Scan the student's card or enter the card ID manually</small>
        </div>
        
        <div class="form-group">
            <label for="transaction_type">Transaction Type *</label>
            <select id="transaction_type" name="transaction_type" required>
                <option value="purchase">Purchase (Deduct Points)</option>
                <option value="credit">Credit (Add Points)</option>
                <option value="refund">Refund</option>
                <option value="adjustment">Balance Adjustment</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="amount">Amount (Points) *</label>
            <input type="number" id="amount" name="amount" required min="1" 
                   placeholder="e.g., 50">
            <small style="color: #6c757d;">Enter the number of points (always positive - system will deduct for purchases)</small>
        </div>
        
        <div class="form-group">
            <label for="description">Description</label>
            <input type="text" id="description" name="description" 
                   placeholder="e.g., School store purchase, Homework reward">
        </div>
        
        <div class="form-group">
            <label for="location">Location</label>
            <input type="text" id="location" name="location" 
                   placeholder="e.g., School Store, Cafeteria, Classroom">
        </div>
        
        <div style="margin-top: 30px;">
            <button type="submit" class="btn">Process Transaction</button>
            <button type="reset" class="btn btn-secondary">Clear Form</button>
        </div>
    </form>
</div>

<div class="card">
    <h2>üîç Quick Card Lookup</h2>
    <p>Enter a card ID to check the student's current balance:</p>
    
    <div style="margin-top: 15px;">
        <input type="text" id="lookup_card" placeholder="Enter card ID" 
               style="padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; width: 300px; margin-right: 10px;">
        <button onclick="lookupCard()" class="btn">Check Balance</button>
    </div>
    
    <div id="lookup_result" style="margin-top: 20px;"></div>
</div>

<script>
function lookupCard() {
    const cardId = document.getElementById('lookup_card').value;
    const resultDiv = document.getElementById('lookup_result');
    
    if (!cardId) {
        resultDiv.innerHTML = '<p style="color: #dc3545;">Please enter a card ID</p>';
        return;
    }
    
    resultDiv.innerHTML = '<p style="color: #6c757d;">Looking up card...</p>';
    
    fetch(`/api/check_card/${cardId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultDiv.innerHTML = `
                    <div style="background: #d4edda; padding: 20px; border-radius: 8px; border: 1px solid #c3e6cb;">
                        <h3 style="color: #155724; margin-bottom: 10px;">‚úì Card Found</h3>
                        <p><strong>Student:</strong> ${data.name}</p>
                        <p><strong>Class:</strong> ${data.class || 'N/A'}</p>
                        <p><strong>Current Balance:</strong> <span style="font-size: 1.3em; font-weight: bold;">${data.balance} points</span></p>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div style="background: #f8d7da; padding: 20px; border-radius: 8px; border: 1px solid #f5c6cb;">
                        <h3 style="color: #721c24;">‚úó Card Not Found</h3>
                        <p>No student found with card ID: ${cardId}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            resultDiv.innerHTML = '<p style="color: #dc3545;">Error looking up card. Please try again.</p>';
        });
}

// Allow Enter key to trigger lookup
document.getElementById('lookup_card').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        lookupCard();
    }
});
</script>
{% endblock %}
